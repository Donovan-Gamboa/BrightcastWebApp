<div class="game-container">

  <div *ngIf="viewingGraveyard && me" class="modal-overlay">
    <div class="modal-content">
      <h2>Your Discard Pile</h2>
      <div class="graveyard-grid">
        <div class="card"
             *ngFor="let card of me.discardPile; let i = index"
             [class.targetable]="targetingState === 'OWN_GRAVEYARD'"
             (click)="onGraveyardCardClick(i)">
          <img [src]="'assets/cards/' + card + '.jpg'" class="card-img" alt="{{ card }}">
        </div>
        <div *ngIf="me.discardPile.length === 0">Pile is empty</div>
      </div>
      <button style="margin-top: 20px; background: #e74c3c;" (click)="toggleGraveyard()">Close</button>
    </div>
  </div>

  <div *ngIf="viewingEnemyHand && opponent" class="modal-overlay">
    <div class="modal-content" style="border-color: #2ecc71;">
      <h2>Opponent's Hand</h2>
      <p>Select a card to force them to discard.</p>
      <div class="graveyard-grid">
        <div class="card"
             *ngFor="let card of opponent.hand; let i = index"
             [class.targetable]="targetingState === 'ENEMY_HAND'"
             (click)="onEnemyHandCardClick(i)">
          <img [src]="'assets/cards/' + card + '.jpg'" class="card-img" alt="{{ card }}">
        </div>
      </div>
      <button style="margin-top: 20px; background: #e74c3c;" (click)="cancelTargeting()">Cancel</button>
    </div>
  </div>

  <div *ngIf="targetingState !== 'NONE'" class="targeting-banner">
    <span *ngIf="selectedTargets.length === 0">Select Targets...</span>
    <span *ngIf="selectedTargets.length > 0">{{ selectedTargets.length }} targets selected!</span>
    <button *ngIf="selectedTargets.length > 0" (click)="confirmDragonAttack()" style="margin-left: 15px; background: #c0392b; font-size: 0.9rem;">ðŸ”¥ DESTROY</button>
    <button (click)="cancelTargeting()" style="margin-left: 10px; background: #7f8c8d; font-size: 0.9rem;">Cancel</button>
  </div>

  <div *ngIf="!gameState" class="lobby">
    <h1 style="font-size: 4rem; color: var(--accent-gold); text-shadow: 0 0 20px rgba(255, 204, 0, 0.5);">Brightcast</h1>
    <div style="background: var(--bg-panel); padding: 40px; border-radius: 20px; border: 2px solid var(--border-color); display: flex; flex-direction: column; gap: 20px; width: 300px;">
      <label style="text-align: left; font-weight: bold; color: var(--accent-blue);">ENTER YOUR NAME</label>
      <input #nameInput type="text" placeholder="e.g. Wizard123"
             style="padding: 10px; border-radius: 8px; border: none; background: rgba(0,0,0,0.3); color: white; font-weight: bold;">
      <hr style="width: 100%; border-color: rgba(255,255,255,0.1);">
      <button (click)="createGame(nameInput.value)">CREATE NEW GAME</button>
      <div style="text-align: center; color: rgba(255,255,255,0.5); font-size: 0.8rem;">- OR -</div>
      <label style="text-align: left; font-weight: bold; color: var(--accent-green);">JOIN GAME ID</label>
      <div style="display: flex; gap: 10px;">
        <input #idInput type="text" placeholder="ABCD" maxlength="4" style="width: 80px; text-transform: uppercase; text-align: center; padding: 10px; border-radius: 8px; border: none; background: rgba(0,0,0,0.3); color: white; font-weight: bold;">
        <button (click)="joinGame(idInput.value, nameInput.value)" style="flex: 1; background: var(--accent-green);">JOIN</button>
      </div>
    </div>
  </div>

  <div *ngIf="gameState && !opponent" class="lobby">
    <h1>Waiting for Player 2...</h1>
    <div style="font-size: 1.5rem;">GAME ID: <strong style="color: var(--accent-gold); font-size: 3rem;">{{ gameState.gameId }}</strong></div>
    <p>Tell your friend to join using this code!</p>
  </div>

  <div *ngIf="gameState?.status === 'WAITING_FOR_INTERRUPT' && !isMyTurn" class="modal-overlay">
    <div class="modal-content" style="border-color: #f39c12;">
      <h2>âš¡ INTERRUPT?</h2>
      <p>Opponent played <strong>{{ gameState?.pendingCard }}</strong>.</p>
      <div *ngIf="gameState?.pendingTargetIndex !== null && gameState?.pendingCard === 'SORCERER'"
           style="background: rgba(0,0,0,0.3); padding: 10px; margin: 10px 0; border-radius: 5px;">
        Targeting your board card:
        <strong>{{ me?.board?.[gameState!.pendingTargetIndex!]?.currentCard }}</strong>
      </div>
      <p>Discard Wizard + Matching Card to stop it?</p>
      <div style="display: flex; gap: 20px; justify-content: center; margin-top: 20px;">
        <button (click)="respondToInterrupt(true)" style="background: #e74c3c;">YES</button>
        <button (click)="respondToInterrupt(false)" style="background: #27ae60;">NO</button>
      </div>
    </div>
  </div>

  <div *ngIf="gameState && me && opponent" class="board">

    <div class="opponent-area" [class.active-turn]="!isMyTurn">
      <h3>Opponent: {{ opponent.name }}</h3>
      <div class="hand-back">
        <div class="card" *ngFor="let c of [].constructor(opponent.handSize)">
          <img src="assets/cards/BACK_OPPONENT.jpg" class="card-img" style="border: 1px solid #aaa;">
        </div>
      </div>
      <div class="field">
        <div class="card-stack-group" *ngFor="let stack of getStackedBoard(opponent)">
          <div class="card stacked-card"
               *ngFor="let cardWrapper of stack.cards; let i = index"
               [style.marginTop.px]="i * 25" [style.zIndex]="i"
               [class.targetable]="targetingState === 'ENEMY_BOARD'"
               [class.marked-for-death]="selectedTargets.includes(cardWrapper.originalIndex)"
               (click)="onOpponentBoardClick(cardWrapper.originalIndex)">
            <img [src]="'assets/cards/' + cardWrapper.instance.currentCard + '.jpg'" class="card-img">
          </div>
        </div>
      </div>
    </div>

    <div class="center-info" style="height: auto; min-height: 120px;">
      <div [class.your-turn]="isMyTurn" style="margin-top: 5px; font-size: 1.5rem;">
        {{ isMyTurn ? "YOUR TURN" : "OPPONENT'S TURN" }}
      </div>
      <div style="height: 80px; width: 400px; background: rgba(0,0,0,0.6); overflow-y: auto; text-align: left; padding: 10px; border-radius: 8px; font-size: 0.8rem; border: 1px solid #555; margin-top: 5px;">
        <div *ngFor="let log of gameState.logs" style="margin-bottom: 2px; color: #bdc3c7;">
          > {{ log }}
        </div>
      </div>
    </div>

    <div class="player-area" [class.active-turn]="isMyTurn">
      <div class="action-bar" style="display: flex; gap: 40px; margin-bottom: 10px; align-items: flex-start;">

        <div style="display: flex; gap: 15px;">
          <div class="deck" (click)="toggleGraveyard()" style="cursor: pointer; position: relative;">
            <ng-container *ngIf="getTopDiscard(me) as topCard; else emptyDiscard">
              <img [src]="'assets/cards/' + topCard + '.jpg'" class="card-img">
            </ng-container>
            <ng-template #emptyDiscard>
              <img src="assets/cards/BACK_MINE.jpg" class="card-img" style="filter: grayscale(100%) opacity(0.5);">
              <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-weight: bold; font-size: 0.8rem;">EMPTY</div>
            </ng-template>
          </div>

          <div class="deck" (click)="drawCard()" [class.playable]="isMyTurn && gameState.turnPhase === 'DRAW' && targetingState === 'NONE'">
            <img src="assets/cards/BACK_MINE.jpg" class="card-img" style="border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.5);">
            <div *ngIf="isMyTurn && gameState.turnPhase === 'DRAW'" style="position: absolute; width: 100%; text-align: center; top: -25px; color: #2ecc71; font-weight: bold; font-size: 0.8rem; animation: pulse 1s infinite;">DRAW!</div>
          </div>

          <div *ngIf="isMyTurn && gameState.turnPhase === 'MAIN'"
               class="deck"
               (click)="skipTurn()"
               style="cursor: pointer; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.5); border-radius: 8px; border: 2px dashed #e74c3c;">
            <div style="text-align: center; color: #e74c3c; font-weight: bold; font-size: 0.8rem;">
              SKIP<br>&<br>DRAW
            </div>
          </div>
        </div>

        <div class="field" style="margin-left: 20px; padding-top: 0;">
          <div class="card-stack-group" *ngFor="let stack of getStackedBoard(me)">
            <div class="card stacked-card"
                 *ngFor="let cardWrapper of stack.cards; let i = index"
                 [style.marginTop.px]="i * 25" [style.zIndex]="i"
                 [class.targetable]="targetingState === 'OWN_BOARD'"
                 (click)="onOwnBoardClick(cardWrapper.originalIndex)">
              <img [src]="'assets/cards/' + cardWrapper.instance.currentCard + '.jpg'" class="card-img">
            </div>
          </div>
        </div>
      </div>

      <h3>You: {{ me.name }}</h3>

      <div class="hand">
        <div class="card"
             [class.playable]="isMyTurn && gameState.turnPhase === 'MAIN' && targetingState === 'NONE'"
             [class.targetable]="targetingState === 'OWN_HAND'"
             [class.selected]="i === selectedHandIndex"
             [style.opacity]="(isMyTurn && gameState.turnPhase === 'DRAW') ? '0.5' : '1'"
             *ngFor="let card of me.hand; let i = index"
             (click)="onHandClick(i)">
          <img [src]="'assets/cards/' + card + '.jpg'" class="card-img" alt="{{ card }}">
        </div>
      </div>
    </div>

    <div *ngIf="gameState.status === 'FINISHED'" class="modal-overlay">
      <div class="modal-content" style="border-color: #f1c40f; background: linear-gradient(135deg, #2c3e50 0%, #000000 100%);">
        <h1 style="font-size: 4rem; margin: 0; color: #f1c40f; text-shadow: 0 0 20px rgba(241, 196, 15, 0.5);">
          {{ gameState.winnerName === playerName ? 'VICTORY!' : 'DEFEAT' }}
        </h1>
        <p style="font-size: 1.5rem; margin: 20px 0; color: #ecf0f1;">
          <strong>{{ gameState.winnerName }}</strong> has won the match!
        </p>
        <div style="margin: 20px 0;">
          <img src="assets/cards/SAGE.jpg" style="width: 120px; border-radius: 10px; border: 3px solid #f1c40f; box-shadow: 0 0 30px rgba(241, 196, 15, 0.3);">
        </div>
        <div style="display: flex; gap: 20px; justify-content: center;">
          <button (click)="leaveGame()" style="background: #e67e22; padding: 15px 30px; font-size: 1.2rem;">
            BACK TO LOBBY
          </button>
        </div>
      </div>
    </div>

  </div>
</div>
